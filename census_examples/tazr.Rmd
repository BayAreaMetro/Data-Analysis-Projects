
```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE)
```

## Goal

Our goal will be to reproduce an equivalence table relating year 2000 Bay Area Census Tracts to MTC's Transportation Analysis Zones (TAZ). 

The long-term goal is to be able to reproduce this lookup table for any census geographies. It may also be useful to reproduce the table for other kinds of geographies (e.g. jurisdictions).

For convenience, we've packaged the year 2000 tract-taz lookup table and the TAZ geometries in this R package. 

If you'd like to look at the raw data please check out the data-raw/ directory for this project on github. We've generally tried to follow the guidelines for building data in R packages outlined here: http://r-pkgs.had.co.nz/data.html

### Lookup Table

Lets inspect the lookup table that we want to reproduce. 

```{r}
library(readr)
Tract_zone_2000 <- read_csv("https://s3-us-west-2.amazonaws.com/equivalence/Tract_zone_2000.csv")

knitr::kable(head(Tract_zone_2000))
```

So, we'll need to look up the ID for all TAZs that relate to a Census Tract, by ID.


TAZ Data
----------
We download and read TAZ Data from MTC's open data portal.

```{r}
library(sf)

taz1454 <- st_read("https://opendata.arcgis.com/datasets/b85ba4d43f9843128d3542260d9a2f1f_0.geojson")

knitr::kable(table(st_is_valid(taz1454)))
```

One of the TAZ geometries is "invalid".
this is probably not important but could be, so lets look into it

```{r}
plot(taz1454[!st_is_valid(taz1454),], max.plot=1)
```

geom looks OK visually
lets make note of the taz_id to review later

```{r}
invalid_taz_id <- taz1454[!st_is_valid(taz1454),]$TAZ1454
```

note: this is not a data type issue per se (geojson, M drive, etc)
i also checked the source shapefile on M and it has the same
invalid geometry (plus another additional one)
arcmap does not see any of these geometries as invalid

Census Data
----------
We download and read Census Data from the US Census.
we use the tigris package but you have lots of options for this
again, its important that you know that the geometries are valid
so we'll check this.

```{r, include = FALSE}
library(tigris)
counties=c("01","13","41","55","75","81","85","95","97")
tracts <- tigris::tracts("CA", counties, class="sf", year=2000)
tracts <- dplyr::select(tracts,TRACTCE00)
tracts <- dplyr::rename(tracts,tract = TRACTCE00)
tracts <- sf::st_transform(tracts, crs=26910)
detach("package:tigris", unload=TRUE)

knitr::kable(table(st_is_valid(tracts)))
```

# ------------------------------------------------------------------------

clean up the headers and data
# ------------------------------------------------------------------------

```{r}
taz1454 <- dplyr::select(taz1454,TAZ1454)
taz1454 <- dplyr::rename(taz1454, taz = TAZ1454)
print(head(taz1454))

taz1454 <- sf::st_transform(taz1454, crs=26910)
```

Join the geometries together. 

```{r}
tt <- sf::st_join(tracts,taz1454)
tt <- as.data.frame(tt)
tt <- dplyr::select(tt,-geometry)
print(head(tt))
```

Check the problem geom

```{r}
knitr::kable(tt[tt$taz==invalid_taz_id,])
```

###Output desired table format

Ok so its now time to format the tt table
in the sparse matrix style format from the 2000 data

```{r}
tt$num <- ave(tt[['taz']], 
              tt[['tract']], 
              FUN = seq_along)

tt$header_string <- 'rtaz'

et <- tt %>% 
  tidyr::unite("header_string", 
                   header_string, 
                   num) %>% 
    tidyr::spread(header_string, taz)

knitr::kable(head(et))
```

Looks like there are more taz intersections in this data set than the lookup from the year 2000
the year 2000 data had maximum 6 taz intersections per tract.
this has many more (more than 10)

lets have a look at the first tract to see why that might be the case

```{r}
tract1 <- tracts[tracts$tract=="010100",]

tazs1 <- taz1454[taz1454$taz %in% 
                   tt[tt$tract=="010100",]$taz,]

plot(tract1, col="red", max.plot=1)

plot(tazs1, 
     col = sf.colors(categorical = TRUE, alpha = .5),
     add=TRUE)
```

When we plot it, its clear that the taz extends slightly into nearby tracts

Here's what that intersection looks like in meters squared
How do we want to resolve these intersections?
Just have each tract get the 6 taz's with the largest areas of intersection?

```{r}
intersection_df <- st_intersection(tract1,tazs1)
intersection_df$area <- st_area(intersection_df)

st_geometry(intersection_df) <- NULL

knitr::kable(intersection_df)
```
