---
title: "Summarise Clipper Institutional Cards"
author: "Tom Buckley"
date: "8/14/2018"
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup

```{r, message=FALSE, warning=FALSE, results='hide'}
library(clpr)
library(dplyr)
library(readr)
library(lubridate)
library(DBI)
library(RSQLite)
source("~/.keys/rs.R")
rs <- connect_rs()
```

## Goal 

Output a table like this:

```{r}
clipper_institutions_df <- tribble(
  ~institutional_type, ~count_of_cards,
  #--|--
  'College/University Card',10,
  'Employer/Tax Subsidy Card',10,
  'Total Cards',1000
)
```

Keeping in mind that an even more useful table would include geography (e.g. zip) and card amounts:

```{r}
named_route_types_df <- tribble(
  #--|--
  60,TRUE,card_id,zip,institution,count 
)
```

```{r}
#you can use ogr2ogr to clean csv and load to your favorite local db
#e.g. : ogr2ogr -f SQLite fastrak.sqlite example_fastrak_file.csv
clprdb <- dbConnect(RSQLite::SQLite(), "~/Data/clipper.sqlite")

tbl1 <- tbl(clprdb,'Clipper_Accounts_Feb_2018v3')

tbl2 <- tbl(clprdb,'clipper_profile')
```

```{r}
brkl_card_id <- YLCARDNO

brk_card <- tbl1 %>%
  filter(card_serial_number==brkl_card_id)
```

not present because unregistered card. 

Example institutional entries. Use these to look up "discounted" generally. 

There may be errors/duplicates. From this folder on Box:

https://mtcdrive.app.box.com/folder/37839075675

INSTITUTION_ID	INSTITUTION_NAME	InstitutionID	operatorid	ContractID	ContractName
244	UC Berkeley Class Pass	157	17	616	Standard ECO Pass
245	The Homes at Central Park	157	17	618	University ECO Pass
25	UC Berkeley	25	1	110	AC Transit EasyPass

```{r}
transactions <- dplyr::tbl(rs,
                           dbplyr::in_schema("clipper",
                                             "sfofaretransaction"))

ks_trans <- transactions %>%
  filter(applicationserialnumber %in% card_ids) %>%
  as_tibble()

```

