---
title: "Summarise Clipper Institutional Cards"
author: "Tom Buckley"
date: "8/14/2018"
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup

```{r, message=FALSE, warning=FALSE, results='hide'}
library(clpr)
library(dplyr)
library(dbplyr)
library(readr)
library(lubridate)
library(DBI)
library(RSQLite)
library(readxl)
source("~/.keys/rs.R")
rs <- connect_rs()
```

## Goal 

Output a table like this:

```{r}
clipper_institutions_df <- tribble(
  ~institutional_type, ~count_of_cards,
  #--|--
  'College/University Card',10,
  'Employer/Tax Subsidy Card',10,
  'Total Cards',1000
)
```

Keeping in mind that an even more useful table would include geography (e.g. zip) and card amounts:

```{r}
named_route_types_df <- tribble(
  #--|--
  60,TRUE,card_id,zip,institution,count 
)
```

## Data Sources

Example institutional entries. Use these to look up "discounted" generally. 

These are also in the database, but require linking multiple tables. This spreadsheet provides us a quick check on whether we can eventually find any kinds of results related to these kind of discount cardfs in the database. From this folder on Box:

https://mtcdrive.app.box.com/folder/37839075675

Download the full list of products [on box (mtc staff)](https://mtcdrive.box.com/s/ondfvfum44b40w3sya35eawqlfxfpa27). 

We read just one of the sheets (see footnotes for more detail)

```{r}
institutions2 <- read_excel('/Users/tommtc/Data/InstitutionID\ descriptions_Feb_2018.xls', sheet='Sheet1')
```

We need to see if any of these values are available to us. They are not directly on the accounts table. 

## Methods

Contract ID is on the transactions table from 2016. So we may be able to use that. 

```{r}
date <- "2016-04-25"
transactions_tbl <- day_of_transactions(rs,date)
transactions_df <- as_tibble(transactions_tbl)
```

```{r}
total_tr <- dim(transactions_df)[1]

df_summary <- transactions_df %>% 
  group_by(operatorid,contractid) %>% 
  summarise(count = n()) %>%
  select(operatorid,contractid,count)

```

Now lets join this back to the spreadsheet. 

```{r}
product_metadata <-  
  institutions2 %>% 
  select(operatorid,ContractID,ContractName)
```


```{r}
df_summary2 <- left_join(df_summary,
                                    product_metadata,
                                    by=c("operatorid"="operatorid",
                                         "contractid"="ContractID"))

df_summary2 <- df_summary2 %>% 
  group_by(ContractName) %>% 
  summarise(total = sum(count))

knitr::kable(head(arrange(df_summary2,
                          desc(total)),
                  n=20))
```

OK, so this gives us a sense of proportion (the unit here is transactions, not cards, which is the ideal output), and we know that we can get a sense of discount-card transactions. 

We also want to know transaction source zip code. We'll need to go back to the database for that. 

*footnotes: 

There might be some confusion about sheets in the institutions table "Sheet    1" (space exaggerated for clarity) Berkeley includes 2 entries, and the one with `institution ID:244` maps to the 'Standard ECO Pass'. While "Sheet1" (no space) maps `institution ID:244` to `AC Transit EasyPass`.
