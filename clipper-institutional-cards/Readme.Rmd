---
title: "Summarise Clipper Institutional Cards"
author: "Tom Buckley"
date: "8/14/2018"
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup

```{r, message=FALSE, warning=FALSE, results='hide'}
library(clpr)
library(dplyr)
library(dbplyr)
library(readr)
library(lubridate)
library(DBI)
library(RSQLite)
library(readxl)
source("~/.keys/rs.R")
rs <- connect_rs()
```

## Goal 

Output a table like this:

```{r}
clipper_institutions_df <- tribble(
  ~institutional_type, ~count_of_cards,
  #--|--
  'College/University Card',10,
  'Employer/Tax Subsidy Card',10,
  'Total Cards',1000
)
```

Keeping in mind that an even more useful table would include geography (e.g. zip) and card amounts:

```{r}
named_route_types_df <- tribble(
  #--|--
  60,TRUE,card_id,zip,institution,count 
)
```

## Data Sources

DV Data Lake

```{r}
source("~/.keys/rs.R")
rs <- connect_rs()
```


## Methods

```{r}
product_summary <- function(df1) {
  prod_summary <- df1 %>%
    group_by(product_description) %>%
    summarise(count=n_distinct(cardid_anony))
  return(prod_summary)
}
```


```{r}

start <- as.Date("10-02-16",format="%m-%d-%y")
end   <- as.Date("10-08-16",format="%m-%d-%y")

dates <- seq(start, end, by="day")

l_dfs <- lapply(dates, function(x) {
  product_summary(get_product_description(day_of_transactions(rs,x)))
})

for(i in seq_along(dates)){
  filename <- paste0("clpr-bart-prod-summary",dates[i],".xlsx")
  try(writexl::write_xlsx(l_dfs[i],filename))
}
```